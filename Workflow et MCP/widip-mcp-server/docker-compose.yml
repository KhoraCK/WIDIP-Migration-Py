# =============================================================================
# Docker Compose pour WIDIP MCP Server v2.0
# Serveur MCP centralisÃ© avec SAFEGUARD, Redis et PostgreSQL
# =============================================================================

version: "3.8"

services:
  # ---------------------------------------------------------------------------
  # WIDIP MCP Server v2.0
  # ---------------------------------------------------------------------------
  widip-mcp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: widip-mcp-server
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      # Server
      - MCP_SERVER_HOST=0.0.0.0
      - MCP_SERVER_PORT=3001
      - MCP_SERVER_DEBUG=${MCP_SERVER_DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Security (SAFEGUARD)
      - MCP_API_KEY=${MCP_API_KEY}
      - MCP_REQUIRE_AUTH=${MCP_REQUIRE_AUTH:-true}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:5678,http://n8n:5678}
      - SAFEGUARD_ENABLED=${SAFEGUARD_ENABLED:-true}

      # GLPI
      - GLPI_URL=${GLPI_URL}
      - GLPI_APP_TOKEN=${GLPI_APP_TOKEN}
      - GLPI_USER_TOKEN=${GLPI_USER_TOKEN}

      # Observium
      - OBSERVIUM_URL=${OBSERVIUM_URL}
      - OBSERVIUM_USER=${OBSERVIUM_USER}
      - OBSERVIUM_PASS=${OBSERVIUM_PASS}

      # LDAP/Active Directory
      - LDAP_SERVER=${LDAP_SERVER}
      - LDAP_USE_SSL=${LDAP_USE_SSL:-false}
      - LDAP_BASE_DN=${LDAP_BASE_DN}
      - LDAP_BIND_USER=${LDAP_BIND_USER}
      - LDAP_BIND_PASS=${LDAP_BIND_PASS}
      - LDAP_USER_SEARCH_BASE=${LDAP_USER_SEARCH_BASE}

      # SMTP
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USE_TLS=${SMTP_USE_TLS:-true}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_FROM_NAME=${SMTP_FROM_NAME:-WIDIP}
      - SMTP_FROM_EMAIL=${SMTP_FROM_EMAIL}

      # MySecret
      - MYSECRET_URL=${MYSECRET_URL}
      - MYSECRET_API_KEY=${MYSECRET_API_KEY}

      # PostgreSQL (pour RAG + SAFEGUARD)
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-widip}
      - POSTGRES_PASS=${POSTGRES_PASS}
      - POSTGRES_DB=${POSTGRES_DB:-widip_knowledge}

      # Redis (cache intelligent)
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}

      # Ollama (pour embeddings e5-multilingual-large)
      - OLLAMA_URL=${OLLAMA_URL:-http://ollama:11434}
      - OLLAMA_EMBED_MODEL=${OLLAMA_EMBED_MODEL:-intfloat/multilingual-e5-large}
      - OLLAMA_EMBED_DIMENSIONS=${OLLAMA_EMBED_DIMENSIONS:-1024}

    networks:
      - widip-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:3001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # PostgreSQL avec pgvector (pour RAG Memory + SAFEGUARD)
  # ---------------------------------------------------------------------------
  postgres:
    image: pgvector/pgvector:pg16
    container_name: widip-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-widip}
      - POSTGRES_PASSWORD=${POSTGRES_PASS}
      - POSTGRES_DB=${POSTGRES_DB:-widip_knowledge}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - widip-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-widip}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # Redis (cache intelligent pour WIBOT, sessions GLPI, etc.)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: widip-redis
    restart: unless-stopped
    command: >
      sh -c "if [ -n \"$$REDIS_PASSWORD\" ]; then
        redis-server --appendonly yes --requirepass $$REDIS_PASSWORD;
      else
        redis-server --appendonly yes;
      fi"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - redis-data:/data
    networks:
      - widip-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  widip-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
